# Technical Specification: AI PR Review Action - Phase 1

## 1. Overview

This document provides the technical specification for Phase 1 of the "AI PR Review Action" project. The primary goal of this phase is to transform the existing `ai-pr-review.yml` workflow into a standalone, reusable, and publishable GitHub Action while maintaining 100% feature parity.

This specification is derived from the "Phase 1: Foundation" section of the [AI PR Review Action Roadmap](docs/roadmaps/roadmap-ai-pr-review-action.md).

## 2. Action Definition (`action.yml`)

The `action.yml` file will define the action's metadata, inputs, outputs, and execution environment.

```yaml
name: 'AI PR Review Action'
description: 'An AI-powered GitHub Action for automated pull request reviews using OpenRouter.'
author: 'StillRiver AI'

branding:
  icon: 'git-pull-request'
  color: 'purple'

inputs:
  github_token:
    description: 'GitHub token for API requests.'
    required: true
  openrouter_api_key:
    description: 'OpenRouter API key.'
    required: true
  model:
    description: 'The AI model to use for the review (e.g., anthropic/claude-3.5-sonnet).'
    required: false
    default: 'anthropic/claude-3.5-sonnet'
  review_type:
    description: 'The type of review to perform (e.g., full, security, performance).'
    required: false
    default: 'full'
  max_tokens:
    description: 'The maximum number of tokens for the AI model to generate.'
    required: false
    default: '4096'
  temperature:
    description: 'The temperature for the AI model.'
    required: false
    default: '0.7'
  request_timeout_seconds:
    description: 'Timeout for the OpenRouter API request in seconds.'
    required: false
    default: '300'
  custom_review_rules:
    description: 'Path to a custom ruleset file for the review.'
    required: false
  exclude_patterns:
    description: 'A comma-separated list of glob patterns for files to exclude from the review.'
    required: false

outputs:
  review_comment:
    description: 'The content of the AI-generated review comment.'
  review_status:
    description: 'The status of the review (e.g., success, failure).'

runs:
  using: 'node20'
  main: 'dist/index.js'
```

## 3. Project Structure

The action will be developed using TypeScript and compiled to JavaScript. The project will follow a standard structure:

```
.
├── action.yml
├── package.json
├── tsconfig.json
├── .gitignore
├── dist/
│   └── index.js
├── src/
│   ├── main.ts
│   ├── github.ts
│   ├── openrouter.ts
│   ├── review.ts
│   └── utils.ts
└── tests/
    ├── main.test.ts
    └── ...
```

-   **`src/`**: Contains the TypeScript source code.
-   **`dist/`**: Contains the compiled, distributable JavaScript code, generated by `ncc`.
-   **`tests/`**: Contains unit and integration tests.

## 4. Core Logic Implementation (TypeScript)

The core logic will be modularized into several TypeScript files within the `src/` directory.

### `src/main.ts`
-   **Purpose**: The main entry point for the action.
-   **Responsibilities**:
    -   Parse and validate all input parameters from `action.yml`.
    -   Initialize the GitHub Octokit client.
    -   Orchestrate the review process by calling other modules.
    -   Handle top-level error handling and set action outputs.
    -   Implement the smart triggering logic (check for recent reviews, "ai-review" labels, etc.) to prevent redundant runs.

### `src/github.ts`
-   **Purpose**: Encapsulate all interactions with the GitHub API.
-   **Responsibilities**:
    -   Fetch pull request details and changed files (`getPullRequest`, `getChangedFiles`).
    -   Post, update, and delete review comments.
    -   Manage labels on the pull request (add/remove `ai-review-in-progress`, `ai-review-complete`).
    -   Check the status of CI/CD checks associated with the PR.

### `src/openrouter.ts`
-   **Purpose**: Handle all communication with the OpenRouter API.
-   **Responsibilities**:
    -   Construct the prompt based on the changed files, review type, and custom rules.
    -   Send the request to the specified OpenRouter model.
    -   Implement retry logic with exponential backoff for transient API errors.
    -   Handle API timeouts and rate limits gracefully.

### `src/review.ts`
-   **Purpose**: Contain the core logic for generating the PR review.
-   **Responsibilities**:
    -   Filter files based on `exclude_patterns`.
    -   Generate the final prompt to be sent to the AI model.
    -   Process the AI model's response.
    -   Format the review comment in Markdown.

### `src/utils.ts`
-   **Purpose**: A collection of helper functions used across the action.
-   **Responsibilities**:
    -   Logging functions (info, warning, error).
    -   File content filtering and manipulation.
    -   Any other shared utility logic.

## 5. Build and Packaging

-   **Tool**: We will use `ncc` (`@vercel/ncc`) to compile the TypeScript code, including all `node_modules`, into a single `dist/index.js` file.
-   **Scripts (`package.json`)**:
    ```json
    "scripts": {
      "build": "ncc build src/main.ts -o dist --source-map --license licenses.txt",
      "test": "jest"
    }
    ```
-   **Automation**: The build process will be automated via a GitHub Actions workflow that runs on pushes to the `main` branch, ensuring the `dist/` directory is always up-to-date.

## 6. Testing Strategy

-   **Framework**: Jest will be used for testing.
-   **Unit Tests**: Each module in `src/` will have corresponding unit tests in `tests/`. We will use mocking for external services like the GitHub and OpenRouter APIs.
-   **Integration Tests**: A separate workflow will be created to run the action in a controlled test repository against a sample pull request to validate end-to-end functionality.

## 7. Documentation

-   **`README.md`**: A comprehensive guide covering:
    -   What the action does.
    -   A clear "Getting Started" section with a minimal usage example.
    -   Detailed explanations for all `inputs`.
    -   Advanced usage examples (e.g., using `exclude_patterns`, custom rules).
    -   A "Troubleshooting" section for common errors.
-   **Examples**: A new `examples/` directory will be created to house sample workflows and configurations that demonstrate various use cases (e.g., basic usage, security-focused review, custom rules).
-   **Security**: A `SECURITY.md` file outlining security best practices, especially regarding the `github_token` and `openrouter_api_key`.

## 8. Phase 1 Deliverables Checklist

-   [ ] Functional GitHub Action with all features from `ai-pr-review.yml`.
-   [x] `action.yml` with the comprehensive input system defined above.
-   [ ] Automated build and release pipeline using `ncc`.
-   [ ] Complete documentation suite (`README.md`, `SECURITY.md`).
-   [x] A dedicated `examples/` directory with well-documented examples.
-   [ ] A dedicated test repository demonstrating the action's usage and validating its functionality.
-   [ ] Unit test suite with at least 80% code coverage.
